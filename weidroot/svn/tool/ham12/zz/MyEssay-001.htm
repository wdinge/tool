<!DOCTYPE html>
<HTML>
<HEAD>
    <TITLE>Essay</TITLE>
    <META http-equiv="Content-Type" content="text/html; charset=gb2312">
	<META name="viewport" content="width=device-witdh, initial-scale=1, maximum-scale=1, user-scale=0"> 


    <link rel="stylesheet" type="text/css" href="./css/Default_pad.css">

    <script language="javascript" src="./jq/jquery.js"></script>
	
	<script language="javascript" src="./jq/MyCookies.js"></script>
	



	
	
    <script language="javascript" src="BiblePad-2015.js"  type="text/javascript"></script>
    <script language="javascript" src="BiblePadUtils-2015.js"  type="text/javascript">
    </script>
<style>
body {
    background-color: black;
    color: white;

	
}



input{
    font-size:60px;
    height:92px;

   
  	position:relative;
	top:60px; 
   }
#MenuContainer{
   position:fixed;
   top:5px;
   right:5px;

}

#edit_op, #selFilesList, #voiceinputxx{
   float:right;
   font-size:60px;
   
   	padding:0 0 0 0px;
	margin: 0px 2px 0px 2px;
	z-index:100;
}
.voiceCmd{
 float:right;
 font-size:60px;
 margin: 0px 1px 0px 1px;
 padding:0px 10px 0 10px;
 background-color:#cccccc;
}
#edit_op{
   align: right;
   right:0px;
   width:200px;
}

#selFilesList{
	right:400px;
}
#viceInputContainer{
 position:fixed;
 bottom:10px; 
 left:1px;
 
 width:98%;
 height:200px;
 padding: 0 300px 0px 0px;
 margin:0 30px 0 0px;
}
#voiceinput{
 float:right;
 width:99%;
 height:100%;
 background-color:yellow;
 color:black;
 font-size:50px;
 z-index:200;
}
#watchDog{
 background-color:#cccccc;
 
}
#VoiceInputCmdMode{
 background-color:#cccccc;
 float:right;
}
.voicePiece{
  display:block;
  border: 1px solid #bbbbbb;
 padding: 2px 0px 5px 0px;
}
.vpiece{
  border: 1px solid #0000ff;
}
.popouter{
 background-color:#cccccc;
 border: 1px solid #0000ff;
 padding: 1px 10px 5px 10px;
}

.mainmenulayer{
   padding: 0px 0px 0px 0px;
   margin:  0px 0px 0px 0px;
   border: 2px solid #0000f0;
   width: 100%;
   height:100%;

}
#div_edit{
	background-color:#123000;

	word-wrap:yes;
	white-space: wrap;
   word-wrap: break-word;
}
#div_edit_Code{
	position:relative;
	top:360px;
	height:300px;
}

#tbContainer{
	width:100%;
}

#cright{
	}
</style>    
    
    <script language="javascript">
    if (navigator.cookieEnabled){
	   console.log("document.cookie:"+document.cookie);
    }else{
	   alert("cookieEnabled OFF");
	}
	
	
	
	
	
	
function readAll(){
	console.log("readAll");
	$.ajax({
                  url: "../svc/BoP/MyEssay/MyEssay.readall.svc.php", 
                  data: "",
                  type: 'post',
                  success: function(ret) {
					$("#msg").html("<hr/>+ + +<hr/>"+ret);						
					if( ret.indexOf("Invalid") >=0 ) {
					    alert("err:"+ret);
						window.open("../login/", "_blank");
					}
                  },
                  complete:function(ret,err){
					if(err !=="success"){
						alert(err);
					}
                  }
        });
}

function save_edit(){
	var txt = EditableDiv.get_edit_txt();
	var txtlen = txt.length;
	if(!EditableDiv.hasModified()){
		if(!confirm(txtlen+"(B)\n\nNo changes is found\n\nForce to save?!")){
		    return;
		}
	}
	else if(!confirm(txtlen+"(B)\n\nSave?!" )){
		return;
	}
	save_edit_start(txt,"dlg");
}

function save_edit_start(txt, cmdMode){	
	txt=encodeURIComponent(txt);
	var file=$("#selFilesList").val();
	if(!file) return alert("file="+file);
	console.log("fname="+file);
	$.ajax({
                  url: "../svc/BoP/MyEssay/MyEssay.save.svc.php", 
                  data: "txt="+txt+"&file="+file,
                  type: 'post',
                  success: function(ret) {
					$("#msg").prepend("<hr/>+ + +<hr/>"+ret);						
					if( ret.indexOf("Invalid") >=0 ) {
					    alert("err:"+ret);
						window.open("../login/", "_blank");
					}
					EditableDiv.saveOK();
					text_statistic();
                  },
                  complete:function(ret,err){
                  }
        });
}
function read_diary_fr_txt(fname){
	read_diary(fname);
	$("#selFilesList").val(fname);
}
function read_diary(fname){

	$.ajax({
                  url: "../svc/BoP/MyEssay/MyEssay.read.svc.php", 
                  data: "fname="+fname,
                  type: 'post',
                  success: function(ret) {
                    //alert(ret);
					if(ret.indexOf("Invalid")>=0){
						alert("Sorry, need login first.");
						//window.history.back();
						window.open("../login/", "_blank");
						return;
					}
					EditableDiv.set_edit_txt(ret).saveOK();
					text_statistic();
					//document.getElementById("div_edit").scrollIntoView();
                  },
                  complete:function(ret,err){
                  }
                });
}
function gen_FileOptions(){
	$.ajax({
                  url: "../svc/BoP/MyEssay/MyEssay.FileOptions.svc.php", 
                  data: "fname=1",
                  type: 'post',
                  success: function(ret) {
						//alert(ret);
						$("#selFilesList").append(ret);

						var fname=MyCookies.get("fname","");
						$("#selFilesList").val(fname);
						read_diary(fname);
						//document.getElementById("toptext").scrollIntoView();

	
                  },
                  complete:function(ret,err){
                  }
                });
}	
function Set_Font_Size(){
    var fnt=MyCookies.get("fontsize","40");
    fnt=prompt("*Font "+parseInt(fnt)+"px", "");
    fnt=parseInt(fnt)
    if(fnt<7 || fnt>220){
        return alert("out of range(7,220)");
    }
	MyCookies.set("fontsize",fnt);
	
	Font_Size_Refresh();
};	
function Font_Size_Refresh(){
    var fnt=MyCookies.get("fontsize","40");
	var fontsize = fnt + "px";
	$("#edit_op option[value='FontSize']").text("FontSize:"+fontsize);
	$(".mainmenulayer").css("font-size",fontsize);
	$(".voicePiece").css("font-size",fontsize);
	$(".popouter").css("font-size",fontsize);
};	
function File_Cmds(cmd){
	var div_edit="#div_edit";
		switch(cmd){
			case "save": save_edit();
			break;
			case "ReadAll": readAll();
			break;
			case "FontSize": Set_Font_Size();
			break;
			case "clear":
			if(confirm("Clear edit text?!")){
				$(div_edit).empty();
			}
			break;	
			case "cleanGarbage":
				$("#voiceCollector").empty();
			break;
			case "ul_list":
			   var ht=$(div_edit).html();
			   ht+="<ul><li>aaa</li><li>bbb</li></ul><br/>";
			   $(div_edit).html(ht);
			break;
			case "ol_list":
			   var ht=$(div_edit).html();
			   ht+="<ol><li>aaa</li><li>bbb</li></ol><br/>";
			   $(div_edit).html(ht);
			break;
			case "ViewCode":
			   //var ht=$("#div_edit").html();
			   //$("#div_edit").text(ht);
			   
			   var mode = $(div_edit).attr("mode");
			   if(mode==="code"){
				  var ht=$(div_edit).text();
				  $(div_edit).html(ht).attr("mode","").css("background-color","");
			   }else{
				  var ht=$(div_edit).html();
				  $(div_edit).text(ht).attr("mode","code").css("background-color","#666600");
			   }
			   
			break;
			case "ViewText":
			   var ht=$(div_edit).text();
			   $(div_edit).html(ht);
			break;
			case "htm_BR":
			   var ht=$(div_edit).html();
			   ht+="<br/>";
			   $(div_edit).html(ht);
			break;
			case "htm_HR":
			   var ht=$(div_edit).html();
			   ht+="<hr/><br/>";
			   $(div_edit).html(ht);
			break;
			case "htm_test":
					test();
			break;
		}	
}	



function test(){

};	

	
$(document).ready(function(){

	
    $("#div_edit2").mousemove(function(){
		console.log("mousemove");
		//pressChar("div_edit2",'A');
		//test();
	});
	
    $("#selFilesList").change(function(){
        var fname = $(this).val();
		if(fname.length>0){
			MyCookies.set("fname",fname,77);
		}
		read_diary(fname);
    });
	

	$("#edit_op").change(function(){
		var sel=$(this).val();
		$(this).val("?");
		File_Cmds(sel);
    });
	
	gen_FileOptions();
	
	var fontsize=MyCookies.get("fontsize","40");
	fontsize+="px";

	$(".mainmenulayer").css("font-size",fontsize);
	
	$("#helpnotes").hide();
	
	
	$("#div_edit").focus(function(){
		$("#div_edit").css("background-color","#007700");
	}).blur(function(){
		$("#div_edit").css("background-color","");
	});
	
	$("#voiceinput").keyup(function(){
		voiceInputRunWatchdog=voiceInputRunDelay;
		if(!voiceInputRunWatchdog_setInterval){
			voiceInputRunWatchdog_setInterval=setInterval(voiceInputRun, 500);
		}
	}).change(function(){
		//voiceInputRunWatchdog=voiceInputRunDelay;
	}).focus(function(){
		//$(this).css("width","100%");
		$(this).css("background-color","yellow");
		//document.getElementById("watchDog").scrollIntoView();
	}).blur(function(){
		$(this).css("background-color","#777700");
		voiceInputStop();
	});
	
	$(".voiceCmd").click(function(){
		var cmd=$(this).text();
		EditableDiv.add_edit_txt(cmd);
		$("#voiceinput").blur();
		//$("#div_edit").focus();
		var ta = document.getElementById('div_edit');
		//ta.scrollTop = ta.scrollHeight;
		document.getElementById('div_edit_bottom').scrollIntoView();
	});
	
	$("#watchDog").click(function(){
		$("#voiceinput").focus();
		voiceInputRunDelay++;
	});
	
	$("#VoiceInputCmdMode").click(function(){
		$("#voiceinput").focus();
		voiceInputRunWatchdog++;
	});
	



});





var voiceInputRunWatchdog=9;
var voiceInputRunDelay=3;
var voiceInputRunWatchdog_setInterval=null;
function voiceInputRun(){
	$("#watchDog").text(voiceInputRunWatchdog);
	if(voiceInputRunWatchdog>0){
		voiceInputRunWatchdog--;
		return;
	}
   
	VoiceParser.voiceInputParser();
	voiceInputStop();
}
function voiceInputStop(){
	if(voiceInputRunWatchdog_setInterval){
		clearInterval(voiceInputRunWatchdog_setInterval);
		voiceInputRunWatchdog_setInterval=null;
		$("#watchDog").text("+");
	}
}







var EditableDiv={
get_edit_txt: function (){	
	var txt=$("#div_edit").html();
	var mode=$("#div_edit").attr("mode");
	if(mode==="code"){
		txt=$("#div_edit").text();
	}
	return txt;
},
set_edit_txt: function (txt){	
	var mode=$("#div_edit").attr("mode");
	if(mode==="code"){
		$("#div_edit").text(txt);
	}
	else{
		$("#div_edit").html(txt);
	};
	return this;
},

add_edit_txt: function (str){	
	var txt=this.get_edit_txt();
	if(",.-\:".indexOf(str.trim())>=0) {
		txt=txt.trim();
	}
	this.set_edit_txt(txt+str);
	return this;
},
hasModified: function (str){	
	var txt  =this.get_edit_txt();
	var txt2 =$("#div_edit").attr("oldtxt");
	if(txt===txt2){
		return false;
	}
	return true;
},
saveOK: function (str){	
	var txt=this.get_edit_txt();
	$("#div_edit").attr("oldtxt",txt);
	return this;
},
};




/////////////////////////////////
////+++////
var VoiceParser={
  voiceMode:"edi",//default or 'cmd'

  toggle:function(){
	if('edi'===this.voiceMode){
		this.voiceMode="cmd";
		$("#voiceinput").css("background-color","#ff0000");
	}else{
		this.voiceMode="edi";
		$("#voiceinput").css("background-color","yellow");
	}
	console.log(this.voiceMode);
  },
  parseVoice:function(txt){
	if(this.voiceMode==="cmd"){
		this.parseVoiceCmd(txt);
	}
	else{
		this.parseVoiceEdi(txt);
	}
  },
 
  voiceInput_save_the_file_0:function(){
		var txt = EditableDiv.get_edit_txt();
		var ss="";
		if(!EditableDiv.hasModified()){
			ss += txt.length+"(B)<br/>No changes is found\n\nForce to Save(yes|no)?! ";		    
		}
		else{
			ss +=txt.length+"(B)<br/>Save(yes|no)?! " ;
		}
		this.appendout(ss,"yes|no");
    },
	voiceInput_save_the_file_1:function(){
			var txt = EditableDiv.get_edit_txt();
			save_edit_start(txt, "voiceInput");
	},
	UTI:{
			ads:function(s){
				s=s.trim();
				if(s.length==0) return "";				
				return "<a class='vpiece' onclick='VoiceParser.addin(this)'>"+s+" </a>";
			},
			adm:function(txt){
				var arr=txt.split(' ');
				var ret="",i=0;	
				if(arr.length>1){
					ret += "<a class='popouter' onclick='VoiceParser.toggleMoveTo(this)'>[+]</a>";
					ret += "<a class='popouter' onclick='VoiceParser.addAll(this)'>[*]</a>";
				}

				
				for(i=0;i<arr.length;i++){
					ret += this.ads( arr[i] );
				}
				return ret;
			},
	},
	appendout:function(txt, mode){
		var vp=this.UTI.adm(txt);
		if(mode.length==0) {
			mode="[X]";
		}
		else if("yes|no"===mode){
			vp="";
		    mode=txt;
		}
		var vx="<a onclick='VoiceParser.popout(this)' class='popouter'>"+ mode +"</a>";

		var newOption = $("<div class='voicePiece'>"+vx+vp+"</div>");
		
		$("#voiceCollector").append(newOption);	
		
		
		document.getElementById("watchDog").scrollIntoView();
	},

  parseVoiceCmd:function(txt){
	if( txt.match(this.getRegExp("space$")) ){
	}

	if( txt.match(this.getRegExp("go back$") ) ){
	}
	if( txt.match(/go back$/) ){
	}
	
	if( txt.match(this.getRegExp("backspace$")) ) {
	}	
	else if( txt.match(/backspace$/g) ) {
	}
	if(txt.match(/[N|n]o/)){
		this.appendout("No action!","yes|no");
		this.toggle();
	}
	if(txt.match(/[Y|y]es/)){
		switch(this.cmd){
			case "SAVE_FILE":
			this.voiceInput_save_the_file_1();
			break;
		}
	
		this.toggle();
	}

	
	//save_edit();
    document.getElementById("watchDog").scrollIntoView();
	console.log(txt);  
  },
  parseVoiceEdi:function(txt){
	if( txt.match(/voice command/)){
		//this.toggle();
		//return;
	}
	if( txt.match(/[C|c]lea[r|n]$/g) ){
		this.appendout(txt,"yes|no");	
		return;
	}
	if( txt.match(/(display|show) help$/g) ){
		this.appendout(txt,"yes|no");
		$("#helpnotes").show();
		return;
	}
	if( txt.match(/(hide|remove) help$/g) ){
		this.appendout(txt,"yes|no");
		$("#helpnotes").hide();
		return;
	}
	if( txt.match(/[C|c]lea[r|n] garbage$/g) ){
		this.appendout(txt,"yes|no");
		$("#voiceCollector").empty();
		return;
	}
	if( txt.match(this.getRegExp("horizontal bar")) ){
		this.appendout(txt,"yes|no");
		var txt2=$("#div_edit").html();
		$("#div_edit").html(txt2+"<hr/><br/>");
		return;
	}
	if( txt.match(this.getRegExp("horizontal break$")) ){
		this.appendout(txt,"yes|no");
		var txt2=$("#div_edit").html();
		$("#div_edit").html(txt2+"<br/>");		
		return;
	}
	
	if( txt.match(/save (a|the|this|to) (file)/ ) || txt.match(/save/) ){
		this.appendout(txt,"yes|no");
		this.voiceInput_save_the_file_0();
		this.cmd="SAVE_FILE";
		this.toggle();
		return;
	}	

	this.appendout(txt,"");	
	return;	  
  },
  voiceInput_set:function(txt){
  	$("#voiceinput").val(txt);
	//scroll2bottom
	var ta = document.getElementById('voiceinput');
	ta.scrollTop = ta.scrollHeight;
  },
  voiceInputParser: function(){
	var txt=$("#voiceinput").val();
	this.parseVoice(txt);
	this.voiceInput_set("");
	return;
  },
  
getRegExp:function (str){
	var inpstr="";
	var regstr=inpstr+str;
	var reg = new RegExp(regstr, "g")  //"/" + str + "/g";
	return reg;
},
toggleMoveTo:function (me){
    var bdr=$(me).css("border");
    console.log(bdr);
    var mv2=$(me).parent().attr("MoveTo");
    if( "garbage" != mv2 ){
		$(me).parent().attr("MoveTo","garbage");
		$(me).css("background-color","#ff0000");
		$(me).text("[-]");
    }
    else if( "garbage"===mv2 ){
		$(me).parent().attr("MoveTo","");
		$(me).css("background-color","#cccccc");
		$(me).text("[+]");
    }
    $("#voiceinput").focus();
},
addAll:function (me){
	var txt = $(me).parent().text();
	var idx=txt.indexOf("[");
	txt=txt.substr(9);
	console.log("--"+txt);
	EditableDiv.add_edit_txt(" "+txt);
	$("#voiceinput").blur();
	$("#voiceinput").focus();
	$(me).parent().remove();
},
addin:function (me){
    var mv2=$(me).parent().attr("MoveTo");
    if(mv2!="garbage"){
		var txt = $(me).text();
		txt=" "+txt.trim();
		console.log("+++"+txt);
		
		EditableDiv.add_edit_txt(txt);
		$("#voiceinput").blur();
		//$("#div_edit").focus();
	}
	var pa=$(me).parent();
	$(me).remove();
	var txt=$(pa).text().trim();
	var idx=txt.indexOf("[");
	if(idx==0){
		//$(pa).remove();
	}
},
popout:function (me){
 console.log("--");
 $(me).parent().remove();
 $("#voiceinput").focus();
},

};
////+++///
/////////////////////


	

	
function text_statistic(){
	var txt=$("#div_edit").text();
	var arr=txt.split(" ");
	var ss="<hr/>total words:"+arr.length+", size(B):"+txt.length
	
	var now = new Date();
	var mm="0"+(now.getMonth()+1);
    var dd="0"+now.getDate();
	if(dd.length==3) dd=dd.substr(1);
	if(mm.length==3) mm=mm.substr(1);
    var today = now.getFullYear()+'-'+mm+'-'+dd; 
    if (  $("#selFilesList option[value='"+today+"']").length === 0 ) {
		var newOption = $("<option value='" + today + "'>" + today + "</option>");
		newOption.insertBefore("#selFilesList option:first");
    }
    
    //add most recent at front.
	$("#datetimeinfo").html(today+" (today)"+ss);
}
    </script>

</HEAD>
    <BODY xxxonload="body_onload();">
    <div id="MenuContainer">
		  <select id='edit_op'>
				<option value="?">File</option> 
                <option value="save">save</option>
				<option value="ReadAll">ReadAll</option>
				<option value="FontSize">FontSize:40</option>

                <option value="clear">clearData</option>
				<option value="cleanGarbage">cleanGarbage</option>
				<option value="ul_list">ul list</option>
				<option value="ol_list">ol list</option>
				<option value="htm_BR">break(br)</option>
				<option value="htm_HR">horiz(hr)</option>
				<option value="htm_test">test</option>
		  </select>
	      <select  id="selFilesList"></select>
	</div>
<hr/>

<hr/>
<table id='tbContainer'><caption>Essay</caption>
<tr><td>
<br/><br/><br/><br/><br/><p id='datetimeinfo'>...</p>  
	
</td></tr><tr><td>
		  
		<div class="mainmenulayer" id='div_edit' contenteditable='true'>
        </div>
		





</td></tr><tr><td>
<a id='div_edit_bottom'>...<a>



</td></tr><tr><td>
<div id='helpnotes'>
<ul >
<li>"Comma"ˈ/kämə/ [Inserts a comma.]
</li><li>"Period" /pirēəd/[Inserts a period followed by a space.]
</li><li>"Point" [Inserts a period when used within appropriate context, such as "Android two point two."]
</li><li>"Exclamation point" or "exclamation mark" [Inserts an exclamation point.]
</li><li>"Question mark" [Inserts a question mark.]
</li><li>"Colon" /ˈkōlən/[Inserts a colon.]
</li><li>"Smiley face" [Inserts a :-) smiley face.]
</li><li>"Sad face" [Inserts a :-( frowny face.]
</li><li>"Wink wink" /wiNGk/ [Inserts a ;-) winky face.]
 
 </li><li>"clean Garbage" 
 </li><li>"horizontal break" 
 </li><li>"horizontal bar" 
 </li><li>"backspace" 
 
 </li>
 </ul>
 </div>
</td></tr><tr><td id="voiceCollector">
 
</td></tr><tr><td>
   <a id="watchDog">+</a> 

</td></tr></table>
<hr/>




<div id="viceInputContainer">
<a class='voiceCmd'>. </a><a class='voiceCmd'>, </a><a class='voiceCmd'>-</a><a class='voiceCmd'>: </a>
<a class='voiceCmd'>&nbsp;</a>
<textarea id="voiceinput"  class=""></textarea>
</div>
<hr/><p/><p/><p/><p/><p/><p/><p/>
	    <p id='info'>...</p>		
		<p id='cright'>@</p>	
		<p id='msg'>......</p>
<hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/>		
    </BODY>


</HTML>
