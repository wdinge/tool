(function(){"use strict";angular.module("viroscope-app",["ngSanitize","ui-rangeSlider"])}).call(this),function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l=function(a,b){return function(){return a.apply(b,arguments)}},m=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};f=1,b=2,h=3,c=4,g=5,a=["red","#253494","#2c7fb8","#41b6c4","#a1dab4","#ffffcc"],d=["root","order","family","sub-family","genus","species"],e=function(){function a(b,c,d,e){var f=this;this.name=b,this.parent=c,this.properties=d,this.level=e,this.flatten=l(this.flatten,this),this.showAccordingToAttributes=l(this.showAccordingToAttributes,this),this.invertHidden=l(this.invertHidden,this),this.unpinAll=l(this.unpinAll,this),this.addMorphologyKeywords=l(this.addMorphologyKeywords,this),this.computeAllProperties=l(this.computeAllProperties,this),this.computeFullText=l(this.computeFullText,this),this.ancestors=l(this.ancestors,this),this.addChild=l(this.addChild,this),this.children=[],this.hidden=!1,this.allProperties=null,this.format={ancestry:function(){var a;return function(){var b,c,d,e;for(d=this.ancestors(),e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.name);return e}.call(f).filter(function(a){return"Unassigned"!==a}).join(" / ")},links:function(){var a;return null!=(a=f.allProperties.links)?a:[]},genome:function(){var a;return null==f.allProperties.genome?"not set yet":(a=[],f.allProperties.genome.positive&&a.push("+"),f.allProperties.genome.negative&&a.push("-"),f.allProperties.genome.ambisense&&a.push("+/-"),f.allProperties.genome.type+(f.allProperties.genome.RT?"-RT":"")+(a.length?" ("+a.join(", ")+")":""))},envelope:function(){switch(f.allProperties.envelope){case"N/A":return"N/A";case"both":return"both";case!0:return"yes";case!1:return"no"}return""},morphology:function(){var a;return null!=(a=f.allProperties.morphology)?a:""},genomeLength:function(){return null!=f.allProperties.genome.lengthDescription?f.allProperties.genome.lengthDescription:angular.isArray(f.allProperties.genome.length)?f.allProperties.genome.length[0]+"-"+f.allProperties.genome.length[1]:""},genomeConfiguration:function(){var a;return null!=(null!=(a=f.allProperties.genome)?a.configurationDescription:void 0)?f.allProperties.genome.configurationDescription:""},virionDescription:function(){return null!=f.allProperties.virionDescription?f.allProperties.virionDescription:angular.isArray(f.allProperties.virionSize)?f.allProperties.virionSize[0]+"-"+f.allProperties.virionSize[1]:""},host:function(){var b;return null!=f.allProperties.host?function(){var c,d,e,f;for(e=this.allProperties.host,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(a.hostAbbrevs[b]);return f}.call(f).join(", "):""}}}return a.hostAbbrevs={Al:"Algae",Ar:"Archaea",B:"Bacteria",F:"Fungi",I:"Invertebrates",P:"Plants",Pr:"Protozoa",V:"Vertebrates"},a.prototype.addChild=function(a){return this.children.push(a)},a.prototype.ancestors=function(){var a,b;for(b=[],a=this;a.parent;)b.push(a),a=a.parent;return b.reverse()},a.prototype.computeFullText=function(){var a,b;a=[this.name];for(b in this.allProperties)"genome"!==b&&"boolean"!=typeof this.allProperties[b]&&a.push(JSON.stringify(this.allProperties[b]));if(this.allProperties.genome)for(b in this.allProperties.genome)"boolean"!=typeof this.allProperties.genome[b]&&a.push(JSON.stringify(this.allProperties.genome[b]));return a.push(JSON.stringify(this.format.host())),a.join(" ").toLowerCase()},a.prototype.computeAllProperties=function(){var a,b,c,d,e;for(this.allProperties={},this.parent&&this.parent.allProperties&&angular.extend(this.allProperties,this.parent.allProperties),this.properties&&angular.extend(this.allProperties,this.properties),this.fullText=this.computeFullText(),d=this.children,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.computeAllProperties());return e},a.prototype.addMorphologyKeywords=function(){var a;return(a=function(b){var c,d,e,f,g;for(b.properties.morphology&&!b.properties.morphologyKeywords&&(b.properties.morphologyKeywords=b.properties.morphology),f=b.children,g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(a(c));return g})(this)},a.prototype.unpinAll=function(){var a,b,c,d,e;for(this.fixed=!1,d=this.children,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.unpinAll());return e},a.prototype.invertHidden=function(){var a,b;return a=!this.hidden,(b=function(c){var d,e,f,g,h;for(c.hidden=a,g=c.children,h=[],e=0,f=g.length;f>e;e++)d=g[e],h.push(b(d));return h})(this)},a.prototype.showAccordingToAttributes=function(a){var b,c,d;return(0===a.searchText.length||this.fullText.indexOf(a.searchText.toLowerCase())>-1)&&(void 0===this.allProperties.envelope||a.envelope.enveloped&&this.allProperties.envelope||a.envelope.notEnveloped&&this.allProperties.envelope===!1||a.envelope.both&&"both"===this.allProperties.envelope||a.envelope.NA&&"N/A"===this.allProperties.envelope)&&(void 0===this.allProperties.morphologyKeywords||a.morphology.allantoid&&this.allProperties.morphologyKeywords.indexOf("allantoid")>-1||a.morphology.bacilliform&&this.allProperties.morphologyKeywords.indexOf("bacilliform")>-1||a.morphology.bottleShaped&&this.allProperties.morphologyKeywords.indexOf("bottle-shaped")>-1||a.morphology.bulletShaped&&this.allProperties.morphologyKeywords.indexOf("bullet-shaped")>-1||a.morphology.coiled&&this.allProperties.morphologyKeywords.indexOf("coiled")>-1||a.morphology.dropletShaped&&this.allProperties.morphologyKeywords.indexOf("droplet-shaped")>-1||a.morphology.filamentous&&this.allProperties.morphologyKeywords.indexOf("filamentous")>-1||a.morphology.icosahedral&&this.allProperties.morphologyKeywords.indexOf("icosahedral")>-1||a.morphology.icosahedralHead&&this.allProperties.morphologyKeywords.indexOf("icosahedral head")>-1||a.morphology.icosahedralCore&&this.allProperties.morphologyKeywords.indexOf("icosahedral core")>-1||a.morphology.intracellular&&this.allProperties.morphologyKeywords.indexOf("intracellular")>-1||a.morphology.rnp&&this.allProperties.morphologyKeywords.indexOf("RNP complex")>-1||a.morphology.lemonShaped&&this.allProperties.morphologyKeywords.indexOf("lemon-shaped")>-1||a.morphology.ovoidal&&this.allProperties.morphologyKeywords.indexOf("ovoidal")>-1||a.morphology.pleomorphic&&this.allProperties.morphologyKeywords.indexOf("pleomorphic")>-1||a.morphology.prolateEllipsoid&&this.allProperties.morphologyKeywords.indexOf("prolate ellipsoid")>-1||a.morphology.pseudoIcosahedral&&this.allProperties.morphologyKeywords.indexOf("pseudo-icosahedral")>-1||a.morphology.quasiSpherical&&this.allProperties.morphologyKeywords.indexOf("quasi-spherical")>-1||a.morphology.rodShaped&&this.allProperties.morphologyKeywords.indexOf("rod-shaped")>-1||a.morphology.shortTail&&this.allProperties.morphologyKeywords.indexOf("short tail")>-1||a.morphology.spherical&&this.allProperties.morphologyKeywords.indexOf("spherical")>-1||a.morphology.tail&&this.allProperties.morphologyKeywords.indexOf("tail")>-1||a.morphology.twoTailed&&this.allProperties.morphologyKeywords.indexOf("two-tailed")>-1)&&(void 0===this.allProperties.host||a.host.algae&&m.call(this.allProperties.host,"Al")>=0||a.host.archaea&&m.call(this.allProperties.host,"Ar")>=0||a.host.bacteria&&m.call(this.allProperties.host,"B")>=0||a.host.fungi&&m.call(this.allProperties.host,"F")>=0||a.host.invertebrates&&m.call(this.allProperties.host,"I")>=0||a.host.plants&&m.call(this.allProperties.host,"P")>=0||a.host.protozoa&&m.call(this.allProperties.host,"Pr")>=0||a.host.vertebrates&&m.call(this.allProperties.host,"V")>=0)&&(void 0===(null!=(b=this.allProperties.genome)?b.type:void 0)||a.genome.ssDNAPositive&&"ssDNA"===this.allProperties.genome.type&&this.allProperties.genome.positive||a.genome.ssDNANegative&&"ssDNA"===this.allProperties.genome.type&&this.allProperties.genome.negative||a.genome.ssDNANegativeOrAmbi&&"ssDNA"===this.allProperties.genome.type&&(this.allProperties.genome.negative||this.allProperties.genome.ambisense)||a.genome.ssDNAAmbi&&"ssDNA"===this.allProperties.genome.type&&this.allProperties.genome.ambisense||a.genome.dsDNA&&"dsDNA"===this.allProperties.genome.type||a.genome.dsDNART&&"dsDNA"===this.allProperties.genome.type&&this.allProperties.genome.RT||a.genome.ssRNAPositive&&"ssRNA"===this.allProperties.genome.type&&this.allProperties.genome.positive||a.genome.ssRNARTPositive&&"ssRNA"===this.allProperties.genome.type&&this.allProperties.genome.RT&&this.allProperties.genome.positive||a.genome.ssRNANegative&&"ssRNA"===this.allProperties.genome.type&&this.allProperties.genome.negative||a.genome.ssRNAAmbi&&"ssRNA"===this.allProperties.genome.type&&this.allProperties.genome.ambisense||a.genome.dsRNA&&"dsRNA"===this.allProperties.genome.type)&&(void 0===(null!=(c=this.allProperties.genome)?c.type:void 0)||a.genome.baltimore[0]&&"dsDNA"===this.allProperties.genome.type&&!this.allProperties.genome.RT||a.genome.baltimore[1]&&"ssDNA"===this.allProperties.genome.type||a.genome.baltimore[2]&&"dsRNA"===this.allProperties.genome.type||a.genome.baltimore[3]&&"ssRNA"===this.allProperties.genome.type&&this.allProperties.genome.positive&&!this.allProperties.genome.RT||a.genome.baltimore[4]&&"ssRNA"===this.allProperties.genome.type&&this.allProperties.genome.negative||a.genome.baltimore[5]&&"ssRNA"===this.allProperties.genome.type&&this.allProperties.genome.positive&&this.allProperties.genome.RT||a.genome.baltimore[6]&&"dsDNA"===this.allProperties.genome.type&&this.allProperties.genome.RT)&&(void 0===(null!=(d=this.allProperties.genome)?d.configurationDescription:void 0)||a.genomeOrganization.linear&&this.allProperties.genome.configurationDescription.toLowerCase().indexOf("linear")>-1||a.genomeOrganization.circular&&this.allProperties.genome.configurationDescription.toLowerCase().indexOf("circular")>-1||a.genomeOrganization.coiled&&this.allProperties.genome.configurationDescription.toLowerCase().indexOf("coiled")>-1||a.genomeOrganization.segmented&&this.allProperties.genome.configurationDescription.toLowerCase().indexOf("segments")>-1)&&this.allProperties.virionSize[1]>=a.morphologySlider.sliderMin&&this.allProperties.virionSize[0]<=a.morphologySlider.sliderMax&&this.allProperties.genome.length[1]>=a.genomeSlider.sliderMin&&this.allProperties.genome.length[0]<=a.genomeSlider.sliderMax},a.prototype.flatten=function(a){var b,c,d,e;return d=[],c=[],b=0,e=function(f,g){var i,j,k,l,m,n;for(f.id||(f.id=b++),j=f.hidden||!f.showAccordingToAttributes(a)||f.level===h&&"Unassigned"===f.name||!a.displayUnassignedNodes[0]&&"Unassigned"===f.name||!a.taxonomy[f.level],j||(d.push(f),null!=g&&c.push({level:f.level,source:g,target:f})),m=f.children,n=[],k=0,l=m.length;l>k;k++)i=m[k],n.push(e(i,j?g:f));return n},e(this,null),{nodes:d,links:c}},a}(),i=function(){function b(){this.refresh=l(this.refresh,this),this.keydown=l(this.keydown,this),this.dragend=l(this.dragend,this),this.dragstart=l(this.dragstart,this),this.unpinAll=l(this.unpinAll,this),this.tick=l(this.tick,this),this.mouseOverNode=l(this.mouseOverNode,this),this.mouseOffNode=l(this.mouseOffNode,this),this.mousedown=l(this.mousedown,this),this.rescale=l(this.rescale,this);var a,b,c;this.$scope=null,this.root=null,this.selectedNode=null,c=1050,a=350,this.force=d3.layout.force().size([c,a]).charge(-150).linkDistance(80).on("tick",this.tick),this.drag=this.force.drag().on("dragstart",this.dragstart).on("dragend",this.dragend),b=d3.select("#viroscope").append("svg").attr("class","main-view").attr("width",c).attr("height",a).attr("width","100%").attr("height","85%").attr("viewBox","0 0 "+c+" "+a).attr("preserveAspectRatio","xMidYMid").attr("pointer-events","all").call(d3.behavior.zoom().on("zoom",this.rescale)),this.vis=b.append("svg:g"),this.link=this.vis.selectAll(".link"),this.node=this.vis.selectAll(".node"),d3.select(window).on("keydown",this.keydown)}return b.prototype.rescale=function(){var a,b;return b=d3.event.translate,a=d3.event.scale,this.vis.attr("transform","translate("+b+") scale("+a+")")},b.prototype.mousedown=function(){return this.vis.call(d3.behavior.zoom().on("zoom",this.rescale))},b.prototype.mouseOffNode=function(){return this.selectedNode=null,this.$scope.infoNodeLocked?void 0:(this.$scope.infoNode=null,this.$scope.$apply())},b.prototype.mouseOverNode=function(a){return"root"===a.name||(this.selectedNode=a,this.$scope.infoNodeLocked)?void 0:(this.$scope.infoNode=a,this.$scope.$apply())},b.prototype.tick=function(){return this.link.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),this.node.attr("transform",function(a){return"translate("+a.x+", "+a.y+")"})},b.prototype.unpinAll=function(){return this.root.unpinAll(),this.$scope.nodesPinned=0},b.prototype.dragstart=function(){return this.dragStartTime=Date.now(),d3.event.sourceEvent.stopPropagation()},b.prototype.dragend=function(a){var b,c,d,e,f;if(c=Date.now()-this.dragStartTime,c>150)return a.fixed=!0,this.$scope.nodesPinned++;for(f=a.children,d=0,e=f.length;e>d;d++)b=f[d],b.invertHidden();return this.refresh()},b.prototype.keydown=function(){if(191===d3.event.keyCode&&(d3.event.preventDefault(),document.getElementById("search-input").focus()),this.selectedNode)switch(d3.event.keyCode){case 65:return console.log("Selected node",this.selectedNode);case 76:return this.$scope.infoNode=this.selectedNode,this.$scope.infoNodeLocked=!0,this.$scope.$apply();case 80:return this.selectedNode.fixed=!0,this.$scope.nodesPinned++;case 82:return this.selectedNode.fixed=!1,this.$scope.nodesPinned--,this.$scope.$apply();case 85:return this.$scope.infoNodeLocked=!1,this.$scope.infoNode=this.selectedNode,this.$scope.$apply()}},b.prototype.getCounts=function(a){var b,c,d,e;for(c=[0,0,0,0,0,0],d=0,e=a.length;e>d;d++)b=a[d],"Unassigned"!==b.name&&c[b.level]++;return this.$scope.counts=c},b.prototype.refresh=function(b,c){var e,f,g,h;return b&&(this.root=b,this.$scope=c),e=this.root.flatten(this.$scope),h=e.nodes,f=e.links,this.getCounts(h),this.force.nodes(h).links(f),this.link=this.link.data(f),this.link.exit().remove(),this.link.enter().insert("line",".node").attr("class","link"),this.node=this.node.data(h,function(a){return a.id}).call(this.drag),this.node.exit().remove(),g=this.node.enter().append("g").attr("class","node"),g.append("circle").attr("r",6).on("mouseover",this.mouseOverNode).on("mouseout",this.mouseOffNode),g.append("text").attr("dy","1.5em").text(function(a){return"Unassigned"===a.name?d[a.level]+" not assigned":a.name}),this.node.select("circle").style("fill",function(b){return a[b.level]}),this.force.start()},b}(),j=function(a){var b;return(b=function(a,c,f,h){var i,j,k,l,m;if(l=null!=(m=c.properties)?m:{},j=new e(a,h,l,f),f!==g){k=d[f+1];for(i in c[k])j.addChild(b(i,c[k][i],f+1,j))}return j})("root",a,0,null)},k=function(a){return a.taxonomy=[!0,!0,!0,!0,!1,!1],a.searchText="",a.displayUnassignedNodes=[!0],a.nodesPinned=0,a.infoNode=null,a.infoNodeLocked=!1,a.counts=[0,0,0,0,0,0],a.morphology={allantoid:!0,bacilliform:!0,bottleShaped:!0,bulletShaped:!0,coiled:!0,dropletShaped:!0,filamentous:!0,icosahedral:!0,icosahedralHead:!0,icosahedralCore:!0,intracellular:!0,rnp:!0,lemonShaped:!0,ovoidal:!0,pleomorphic:!0,prolateEllipsoid:!0,pseudoIcosahedral:!0,quasiSpherical:!0,rodShaped:!0,shortTail:!0,spherical:!0,tail:!0,twoTailed:!0},a.morphologySlider={minWidth:1,maxWidth:100,sliderMin:1,sliderMax:100},a.envelope={enveloped:!0,notEnveloped:!0,both:!0,NA:!0},a.host={algae:!0,archaea:!0,bacteria:!0,fungi:!0,invertebrates:!0,plants:!0,protozoa:!0,vertebrates:!0},a.genomeOrganization={linear:!0,circular:!0,coiled:!0,segmented:!0},a.genome={ssDNAPositive:!0,ssDNANegative:!0,ssDNANegativeOrAmbi:!0,ssDNAAmbi:!0,dsDNA:!0,dsDNART:!0,ssRNAPositive:!0,ssRNARTPositive:!0,ssRNANegative:!0,ssRNAAmbi:!0,dsRNA:!0,baltimore:[!0,!0,!0,!0,!0,!0,!0]},a.genomeSlider={minWidth:1,maxWidth:100,sliderMin:1,sliderMax:100},a.setAllGenome=function(b){var c;for(c in a.genome)"baltimore"!==c&&(a.genome[c]=b);return a.genome.baltimore=[b,b,b,b,b,b,b],a.viroscope.refresh()},a.setAll=function(b,c){var d;for(d in a[b])a[b][d]=c;return a.viroscope.refresh()},a.unlockInfoNode=function(){return a.infoNodeLocked=!1},a.unpinAll=function(){return a.viroscope.unpinAll()}},angular.module("viroscope-app").controller("MainCtrl",["$scope","$http",function(a,b){return a.viroscope=new i,k(a),b.get("/api/taxonomy").success(function(b){var c;return c=j(b),c.addMorphologyKeywords(),c.computeAllProperties(),a._converted=c,a.morphologySlider.minWidth=a.morphologySlider.sliderMin=c.allProperties.virionSize[0],a.morphologySlider.maxWidth=a.morphologySlider.sliderMax=c.allProperties.virionSize[1],a.genomeSlider.minWidth=a.genomeSlider.sliderMin=c.allProperties.genome.length[0],a.genomeSlider.maxWidth=a.genomeSlider.sliderMax=c.allProperties.genome.length[1],a.$watch("morphologySlider.sliderMax",function(){return a.viroscope.refresh()}),a.$watch("morphologySlider.sliderMin",function(){return a.viroscope.refresh()}),a.$watch("genomeSlider.sliderMax",function(){return a.viroscope.refresh()}),a.$watch("genomeSlider.sliderMin",function(){return a.viroscope.refresh()}),a.viroscope.refresh(c,a)})}])}.call(this),function(){"use strict";angular.module("viroscope-app").controller("NavbarCtrl",["$scope","$location",function(a,b){return a.menu=[{title:"About",link:"/"}],a.isActive=function(a){return a===b.path()}}])}.call(this);